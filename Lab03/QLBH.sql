USE QLHH
GO

CREATE TABLE VATTU (
	MaVTU CHAR(4) NOT NULL PRIMARY KEY,
	TenVTu VARCHAR(100) NOT NULL UNIQUE,
	DvTinh VARCHAR(10) NULL DEFAULT '',
	PhanTram REAL CHECK (PhanTram>=0 AND PhanTram<=100)
)
GO

CREATE TABLE NHACC (
	MaNhaCc CHAR(3) NOT NULL PRIMARY KEY,
	TenNhaCc VARCHAR(100) NOT NULL UNIQUE,
	DiaChi VARCHAR(200) NOT NULL UNIQUE,
	DienThoai VARCHAR(20) NULL DEFAULT N'Chưa có'
)
GO

CREATE TABLE DONDH (
	SoDh CHAR(4) NOT NULL PRIMARY KEY,
	NgayDh DATETIME DEFAULT GETDATE(),
	MaNhaCc CHAR(3) NOT NULL,
	FOREIGN KEY (MaNhaCc) REFERENCES NHACC(MaNhaCc)
)
GO

CREATE TABLE CTDONDH (
	SoDh CHAR(4) NOT NULL,
	MaVTU CHAR(4) NOT NULL,
	PRIMARY KEY (SoDh, MaVTU),
	SlDat INT NOT NULL CHECK (SlDat > 0),
	FOREIGN KEY (MaVTU) REFERENCES VATTU(MaVTU),
	FOREIGN KEY (SoDh) REFERENCES DONDH(SoDh) 
)
GO

CREATE TABLE PNHAP (
	SoPn CHAR(4) PRIMARY KEY,
	NgayNhap DATETIME DEFAULT GETDATE(),
	SoDh CHAR(4) NOT NULL,
	FOREIGN KEY (SoDh) REFERENCES DONDH(SoDh)
)
GO

CREATE TABLE CTPNHAP (
	SoPn CHAR(4) NOT NULL,
	MaVTU CHAR(4) NOT NULL,
	PRIMARY KEY (SoPn, MaVTU),
	SlNhap INT NOT NULL CHECK (SlNhap > 0),
	DgNhap MONEY NOT NULL CHECK (DgNhap > 0),
	FOREIGN KEY (SoPn) REFERENCES PNHAP (SoPn),
	FOREIGN KEY (MaVTU) REFERENCES VATTU (MaVTU)
)
GO

CREATE TABLE PXUAT (
	SoPx CHAR(4) NOT NULL PRIMARY KEY,
	NgayXuat DATETIME DEFAULT GETDATE(),
	TenKh VARCHAR(100) NOT NULL
)
GO

CREATE TABLE CTPXUAT (
	SoPx CHAR(4) NOT NULL,
	MaVTU CHAR(4) NOT NULL,
	PRIMARY KEY (SoPx, MaVTU),
	SlXuat INT NOT NULL CHECK (SlXuat > 0),
	DgXuat MONEY NOT NULL CHECK (DgXuat > 0),
	FOREIGN KEY (SoPx) REFERENCES PXUAT (SoPx),
	FOREIGN KEY (MaVTU) REFERENCES VATTU (MaVTU)
)
GO

CREATE TABLE TONKHO (
	NamThang CHAR(6) NOT NULL,
	MaVTU CHAR(4) NOT NULL,
	PRIMARY KEY (NamThang, MaVTU),
	SlDau INT NOT NULL CHECK (SlDau >= 0),
	TongSLN INT NOT NULL CHECK (TongSLN >= 0),
	TongSLX INT NOT NULL CHECK (TongSLX >= 0),
	FOREIGN KEY (MaVTU) REFERENCES VATTU (MaVTU),
	SlCuoi AS (CAST(SlDau + TongSLN - TongSLX AS INT)) PERSISTED NOT NULL
)
GO

INSERT INTO NHACC VALUES
('C01', N'Lê Minh Thành', N'54, Kim Mã, Cầu Giấy, Hà Nội', '8781024'),
('C02', N'Trần Quang Anh', N'145, Hùng Vương, Hải Dương', '7698154'),
('C03', N'Bùi Hồng Phương', N'154/85, Lê Chân, Hải Phòng', '9600125'),
('C04', N'Vũ Nhật Thắng', N'198/40 Hương Lộ 14 QTB HCM', '8757757'),
('C05', N'Nguyễn Thị Thúy', N'178 Nguyễn Văn Luông, Đà Lạt', '7964251'),
('C07', N'Cao Minh Trung', N'128 Lê Quang Sung Nha Trang', DEFAULT)
GO

INSERT INTO VATTU VALUES
('DD01', N'Đầu DVD Hitachi 1 đĩa', N'Bộ', 40),
('DD02', N'Đầu DVD Hitachi 3 đĩa', N'Bộ', 40),
('TL15', N'Tủ lạnh Sanyo 150 lít', N'Cái', 25),
('TL90', N'Tủ lạnh Sanyo 90 lít', N'Cái', 20),
('TV14', N'Tivi Sony 14 inches', N'Cái', 15),
('TV21', N'Tivi Sony 21 inches', N'Cái', 10),
('TV29', N'Tivi Sony 29 inches', N'Cái', 10),
('VD01', N'Đầu VCD Sony 1 đĩa', N'Bộ', 30),
('VD02', N'Đầu VDC Sony 3 đĩa', N'Bộ', 30)
GO

INSERT INTO DONDH VALUES
('D001', '2012-01-15', 'C03'),
('D002', '2012-01-30', 'C01'),
('D003', '2012-02-10', 'C02'),
('D004', '2012-02-17', 'C05'),
('D005', '2012-03-01', 'C02'),
('D006', '2012-03-12', 'C05')
GO

INSERT INTO CTDONDH VALUES
('D001', 'DD01', 10),
('D001', 'DD02', 10),
('D002', 'VD01', 10),
('D003', 'TV14', 10),
('D003', 'TV29', 10),
('D004', 'TL90', 10),
('D005', 'TV14', 10),
('D005', 'TV29', 10),
('D006', 'TV14', 10),
('D006', 'TV29', 10),
('D006', 'VD01', 10)
GO

INSERT INTO PNHAP VALUES
('N001', '2012-01-17', 'D001'),
('N002', '2012-01-20', 'D001'),
('N003', '2012-01-31', 'D002'),
('N004', '2012-01-30', 'D002')
GO

INSERT INTO CTPNHAP VALUES
('N001', 'DD01', 8, 2500000),
('N001', 'DD02', 10, 3500000),
('N002', 'DD01', 2, 2500000),
('N002', 'DD02', 5, 3500000),
('N003', 'VD02', 30, 2500000),
('N004', 'TV14', 5, 2500000),
('N004', 'TV29', 12, 3500000)
GO

INSERT INTO PXUAT VALUES
('X001', '2012-01-17', N'Nguyễn Ngọc Phương Nhi'),
('X002', '2012-01-25', N'Nguyễn Hồng Phương'),
('X003', '2012-01-31', N'Nguyễn Tuấn Tú')
GO

INSERT INTO CTPXUAT VALUES
('X001', 'DD01', 2, 3500000),
('X002', 'DD01', 1, 3500000),
('X002', 'DD02', 5, 4900000),
('X003', 'DD01', 3, 3500000),
('X003', 'DD02', 2, 4900000),
('X003', 'VD01', 10, 3250000)
GO

INSERT INTO TONKHO (NamThang, MaVTU, SlDau, TongSLN, TongSLX) VALUES
('201201', 'DD01', 0, 10, 6),
('201201', 'DD02', 0, 15, 7),
('201201', 'VD02', 0, 30, 10),
('201202', 'DD01', 4, 0, 0),
('201202', 'DD02', 8, 0, 0),
('201202', 'VD02', 20, 0, 0),
('201202', 'TV14', 5, 0, 0),
('201202', 'TV29', 12, 0, 0)
GO